# Iris Memory 功能文档

> 版本：v1.6.0  
> 最后更新：2025-02-21

---

## 目录

1. [项目概述与目标](#1-项目概述与目标)
2. [系统架构](#2-系统架构)
3. [核心模块功能说明](#3-核心模块功能说明)
4. [辅助模块功能说明](#4-辅助模块功能说明)
5. [模块间交互关系与数据流向](#5-模块间交互关系与数据流向)
6. [业务处理流程](#6-业务处理流程)
7. [关键功能点与技术实现要点](#7-关键功能点与技术实现要点)
8. [功能使用场景与限制条件](#8-功能使用场景与限制条件)

---

## 1. 项目概述与目标

### 1.1 项目简介

Iris Memory 是一款基于 **companion-memory 框架**的三层记忆插件，为 AstrBot 平台提供智能记忆管理能力。该插件能够自动捕获、存储、检索用户对话中的重要信息，并在后续对话中智能注入相关记忆，使 AI 助手具备"记住用户"的能力。

### 1.2 核心目标

| 目标 | 描述 |
|------|------|
| **智能记忆捕获** | 自动识别对话中值得记忆的内容，无需用户手动记录 |
| **分层记忆管理** | 实现工作记忆、情景记忆、语义记忆三层架构，动态管理记忆生命周期 |
| **精准记忆检索** | 根据对话上下文智能检索相关记忆，提供个性化响应支持 |
| **隐私保护** | 支持敏感度分级、记忆可见性控制，保护用户隐私 |
| **主动交互** | 支持主动回复功能，在适当时机主动与用户互动 |

### 1.3 三层记忆模型

```
┌─────────────────────────────────────────────────────────────┐
│                      语义记忆 (Semantic)                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  永久保存的用户画像、核心价值观、人格特质              │   │
│  │  半衰期：365-730天 | 质量：CONFIRMED                  │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                      情景记忆 (Episodic)                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  基于RIF评分动态管理的对话片段、事件记录              │   │
│  │  半衰期：30-90天 | 动态升降级                         │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                      工作记忆 (Working)                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  会话内临时存储，快速访问的近期对话                   │   │
│  │  生命周期：24小时 | 自动清理                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.4 记忆类型分类

| 类型 | 说明 | 示例 |
|------|------|------|
| **FACT** | 事实类信息，可验证 | "我住在北京"、"我是程序员" |
| **EMOTION** | 情感类信息，情绪状态 | "今天心情不好"、"我很开心" |
| **RELATIONSHIP** | 关系类信息，人际边界 | "你是我最好的朋友" |
| **INTERACTION** | 互动类信息，对话模式 | "喜欢简短的回复" |
| **INFERRED** | 推断类信息，系统推断 | 根据行为推断的偏好 |

---

## 2. 系统架构

### 2.1 整体架构图

```
┌────────────────────────────────────────────────────────────────────┐
│                           Handler 层 (main.py)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  指令处理器   │  │  LLM Hook    │  │  消息处理器   │              │
│  │  /memory_*   │  │  上下文注入   │  │  事件分发     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                        Service 层 (MemoryService)                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    7 个 Feature Modules                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │   │
│  │  │ Storage │ │Capture  │ │Retrieval│ │Analysis │           │   │
│  │  │ Module  │ │ Module  │ │ Module  │ │ Module  │           │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                       │   │
│  │  │Proactive│ │  KG     │ │LLM-     │                       │   │
│  │  │ Module  │ │ Module  │ │Enhanced │                       │   │
│  │  └─────────┘ └─────────┘ └─────────┘                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                           组件层 (Components)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ChromaManager │  │CaptureEngine │  │RetrievalEng. │              │
│  │  向量存储     │  │  记忆捕获     │  │  记忆检索     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │SessionManager│  │BatchProcessor│  │ProactiveMgr  │              │
│  │  会话管理     │  │  批量处理     │  │  主动回复     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │KGExtractor   │  │KGStorage     │  │KGReasoning   │              │
│  │  知识提取     │  │  图谱存储     │  │  图谱推理     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌────────────────────────────────────────────────────────────────────┐
│                           基础设施层 (Infrastructure)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │EmbeddingMgr  │  │ChatHistory   │  │MemberIdentity│              │
│  │  向量嵌入     │  │  Buffer      │  │  Service     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ConfigManager │  │Logger        │  │RateLimiter   │              │
│  │  配置管理     │  │  日志系统     │  │  速率限制     │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└────────────────────────────────────────────────────────────────────┘
```

### 2.2 目录结构

```
iris_memory/
├── main.py                    # 插件入口，Handler层
├── core/                      # 核心定义
│   ├── types.py              # 类型定义（枚举、数据结构）
│   ├── constants.py          # 常量定义
│   ├── defaults.py           # 默认配置
│   ├── config_manager.py     # 配置管理器
│   └── memory_scope.py       # 记忆可见性范围
├── models/                    # 数据模型
│   ├── memory.py             # 记忆数据模型
│   ├── user_persona.py       # 用户画像模型
│   └── emotion_state.py      # 情感状态模型
├── services/                  # 业务服务层
│   ├── memory_service.py     # 主服务类
│   ├── business_operations.py # 业务操作
│   ├── persistence.py        # 持久化操作
│   └── modules/              # 功能模块
│       ├── storage_module.py
│       ├── capture_module.py
│       ├── retrieval_module.py
│       ├── analysis_module.py
│       ├── proactive_module.py
│       ├── kg_module.py
│       └── llm_enhanced_module.py
├── capture/                   # 记忆捕获
│   ├── capture_engine.py     # 捕获引擎
│   ├── batch_processor.py    # 批量处理器
│   ├── message_classifier.py # 消息分类器
│   ├── message_merger.py     # 消息合并器
│   ├── detector/             # 检测器
│   │   ├── trigger_detector.py
│   │   └── sensitivity_detector.py
│   └── conflict/             # 冲突处理
│       ├── conflict_resolver.py
│       └── similarity_calculator.py
├── retrieval/                 # 记忆检索
│   ├── retrieval_engine.py   # 检索引擎
│   ├── retrieval_router.py   # 检索路由
│   └── reranker.py           # 重排序器
├── storage/                   # 存储管理
│   ├── chroma_manager.py     # ChromaDB管理
│   ├── session_manager.py    # 会话管理
│   ├── lifecycle_manager.py  # 生命周期管理
│   └── chat_history_buffer.py # 聊天记录缓冲
├── analysis/                  # 分析模块
│   ├── rif_scorer.py         # RIF评分器
│   ├── emotion/              # 情感分析
│   ├── entity/               # 实体提取
│   └── persona/              # 画像提取
├── knowledge_graph/           # 知识图谱
│   ├── kg_extractor.py       # 三元组提取
│   ├── kg_storage.py         # 图谱存储
│   ├── kg_reasoning.py       # 图谱推理
│   └── kg_context.py         # 上下文构建
├── proactive/                 # 主动回复
│   ├── proactive_manager.py  # 主动回复管理
│   └── proactive_reply_detector.py
├── embedding/                 # 向量嵌入
│   ├── manager.py            # 嵌入管理器
│   ├── astrbot_provider.py   # AstrBot提供者
│   └── local_provider.py     # 本地模型提供者
├── multimodal/                # 多模态处理
│   ├── image_analyzer.py     # 图片分析
│   └── image_cache.py        # 图片缓存
└── utils/                     # 工具函数
    ├── logger.py
    ├── llm_helper.py
    ├── member_identity_service.py
    └── rate_limiter.py
```

## 3. 核心模块功能说明

### 3.1 记忆捕获模块 (Capture Module)

#### 3.1.1 功能概述

记忆捕获模块负责从用户消息中智能识别并提取值得记忆的信息，是整个记忆系统的入口。

#### 3.1.2 核心组件

| 组件 | 职责 | 文件位置 |
|------|------|----------|
| **CaptureEngine** | 记忆捕获主引擎，协调各检测器完成捕获流程 | `capture/capture_engine.py` |
| **BatchProcessor** | 批量消息处理器，优化LLM调用频率 | `capture/batch_processor.py` |
| **MessageClassifier** | 消息分类器，决定处理优先级 | `capture/message_classifier.py` |
| **TriggerDetector** | 触发器检测器，识别记忆触发信号 | `capture/detector/trigger_detector.py` |
| **SensitivityDetector** | 敏感度检测器，识别隐私信息 | `capture/detector/sensitivity_detector.py` |
| **ConflictResolver** | 冲突解决器，处理记忆冲突 | `capture/conflict/conflict_resolver.py` |

#### 3.1.3 捕获流程（14步骤）

```
用户消息输入
     │
     ▼
┌─────────────────┐
│ 1. 负样本检查    │ ── 过滤闲聊、问候语等
└────────┬────────┘
         ▼
┌─────────────────┐
│ 2. 触发器检测    │ ── 识别显式/隐式记忆触发信号
└────────┬────────┘
         ▼
┌─────────────────┐
│ 3. 敏感度检测    │ ── 自动识别敏感信息并分级
└────────┬────────┘
         ▼
┌─────────────────┐
│ 4. 实体提取      │ ── 提取人名、地点、时间等
└────────┬────────┘
         ▼
┌─────────────────┐
│ 5. 情感分析      │ ── 混合模型分析情感状态
└────────┬────────┘
         ▼
┌─────────────────┐
│ 6. 记忆类型确定  │ ── FACT/EMOTION/RELATIONSHIP等
└────────┬────────┘
         ▼
┌─────────────────┐
│ 7. 记忆对象创建  │ ── 构建完整记忆数据结构
└────────┬────────┘
         ▼
┌─────────────────┐
│ 8. 质量评估      │ ── 多维度置信度计算
└────────┬────────┘
         ▼
┌─────────────────┐
│ 9. RIF评分       │ ── 时近性、相关性、频率综合评分
└────────┬────────┘
         ▼
┌─────────────────┐
│10. 存储层确定    │ ── WORKING/EPISODIC/SEMANTIC
└────────┬────────┘
         ▼
┌─────────────────┐
│11. 去重检查      │ ── 避免重复记录
└────────┬────────┘
         ▼
┌─────────────────┐
│12. 冲突检测      │ ── 识别语义冲突
└────────┬────────┘
         ▼
┌─────────────────┐
│13. 冲突解决      │ ── LLM辅助解决冲突（可选）
└────────┬────────┘
         ▼
┌─────────────────┐
│14. 存储记忆      │ ── 写入对应存储层
└─────────────────┘
```

#### 3.1.4 触发器类型

| 触发器类型 | 说明 | 示例关键词 |
|------------|------|------------|
| **EXPLICIT** | 显式触发器 | "记住"、"重要"、"别忘了" |
| **PREFERENCE** | 偏好触发器 | "喜欢"、"讨厌"、"爱" |
| **EMOTION** | 情感触发器 | "觉得"、"感到"、"心情" |
| **RELATIONSHIP** | 关系触发器 | "我们是"、"朋友"、"家人" |
| **FACT** | 事实触发器 | "我是"、"我有"、"我在" |
| **BOUNDARY** | 边界触发器 | "不要"、"不想"、"别" |

#### 3.1.5 敏感度分级

| 等级 | 名称 | 说明 | 处理策略 |
|------|------|------|----------|
| 0 | PUBLIC | 公开信息，无隐私风险 | 正常存储 |
| 1 | PERSONAL | 个人偏好，轻微隐私 | 正常存储 |
| 2 | PRIVATE | 私人信息，需要保护 | 标记保护 |
| 3 | SENSITIVE | 敏感信息，严格保护 | 可能过滤 |
| 4 | CRITICAL | 极度敏感，最高保护 | 强制过滤 |

#### 3.1.6 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 消息为空或仅空白字符 | 直接返回，不捕获 |
| 负样本（问候语、闲聊） | 直接返回，不捕获 |
| 无触发器且非用户请求 | 根据 auto_capture 配置决定 |
| 高敏感度内容（CRITICAL） | 过滤，不存储 |
| 重复记忆检测 | 跳过，返回 None |
| 检测到冲突记忆 | 调用冲突解决器处理 |
| 捕获过程异常 | 记录日志，返回 None |

---

### 3.2 记忆检索模块 (Retrieval Module)

#### 3.2.1 功能概述

记忆检索模块负责根据用户查询从存储中检索相关记忆，并通过重排序优化结果质量。

#### 3.2.2 核心组件

| 组件 | 职责 | 文件位置 |
|------|------|----------|
| **RetrievalEngine** | 检索引擎主类，协调检索流程 | `retrieval/retrieval_engine.py` |
| **RetrievalRouter** | 检索路由器，选择最优检索策略 | `retrieval/retrieval_router.py` |
| **Reranker** | 重排序器，优化检索结果排序 | `retrieval/reranker.py` |

#### 3.2.3 检索策略

| 策略 | 适用场景 | 算法说明 |
|------|----------|----------|
| **VECTOR_ONLY** | 简单关键词查询 | 纯向量相似度检索 |
| **TIME_AWARE** | 包含时间线索的查询 | 时间衰减函数加权 + 向量相似度 |
| **EMOTION_AWARE** | 用户情感状态需考虑 | 负面情感时过滤高强度正面记忆 |
| **GRAPH_ONLY** | 多跳关系推理查询 | 知识图谱遍历检索 |
| **HYBRID** | 复杂多维度查询（默认） | 向量检索 → 情感过滤 → Reranker重排序 |

#### 3.2.4 重排序权重

```
最终得分 = 质量等级(0.25) + RIF评分(0.25) + 时间衰减(0.20) 
         + 向量相似度(0.15) + 访问频率(0.10) + 情感一致性(0.05)
```

| 维度 | 权重 | 说明 |
|------|------|------|
| 质量等级 | 25% | CONFIRMED > HIGH_CONFIDENCE > MODERATE > LOW_CONFIDENCE > UNCERTAIN |
| RIF评分 | 25% | 时近性40% + 相关性30% + 频率30% |
| 时间衰减 | 20% | 新记忆优先，指数衰减 |
| 向量相似度 | 15% | 语义匹配度 |
| 访问频率 | 10% | 热度加权 |
| 情感一致性 | 5% | 情绪匹配度 |

#### 3.2.5 Token预算管理

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 总预算 | 512 tokens | 注入LLM的记忆总token限制 |
| 动态选择 | 启用 | 根据重要性动态选择记忆 |
| 记忆压缩 | 启用 | 长记忆自动生成摘要 |

#### 3.2.6 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 查询为空 | 返回空列表 |
| 无匹配记忆 | 返回空列表 |
| 情感过滤后无结果 | 返回原始结果的前半部分 |
| 检索异常 | 记录日志，返回空列表 |

---

### 3.3 存储模块 (Storage Module)

#### 3.3.1 功能概述

存储模块负责记忆的持久化存储，包括向量数据库管理、会话管理和生命周期管理。

#### 3.3.2 核心组件

| 组件 | 职责 | 文件位置 |
|------|------|----------|
| **ChromaManager** | ChromaDB向量数据库管理 | `storage/chroma_manager.py` |
| **SessionManager** | 会话状态管理 | `storage/session_manager.py` |
| **LifecycleManager** | 记忆生命周期管理 | `storage/lifecycle_manager.py` |
| **ChatHistoryBuffer** | 聊天记录缓冲区 | `storage/chat_history_buffer.py` |

#### 3.3.3 存储层说明

| 存储层 | 存储位置 | 生命周期 | 升级条件 |
|--------|----------|----------|----------|
| **WORKING** | 内存（SessionManager） | 会话内，24小时后清理 | 访问≥1次且重要性>0.5，或情感强度>0.6，或置信度≥0.7 |
| **EPISODIC** | ChromaDB | 基于RIF评分动态管理 | 访问≥10次且置信度>0.8，或质量=CONFIRMED |
| **SEMANTIC** | ChromaDB | 永久保存 | - |

#### 3.3.4 记忆可见性范围

| 范围 | 说明 | 使用场景 |
|------|------|----------|
| **USER_PRIVATE** | 用户私有记忆 | 私聊中的个人信息 |
| **GROUP_SHARED** | 群组共享记忆 | 群公告、群活动、大家共同参与的话题 |
| **GROUP_PRIVATE** | 群组内个人记忆 | 群聊中提及的个人偏好 |
| **GLOBAL** | 全局记忆 | 系统级知识（慎用） |

#### 3.3.5 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 嵌入模型维度冲突 | 自动备份旧数据，创建新集合 |
| ChromaDB未安装 | 抛出明确错误提示 |
| 集合不存在 | 自动创建新集合 |
| 写入失败 | 记录错误日志，不阻塞主流程 |

---

### 3.4 知识图谱模块 (Knowledge Graph Module)

#### 3.4.1 功能概述

知识图谱模块负责从对话中提取实体关系，构建结构化知识网络，支持多跳推理查询。

#### 3.4.2 核心组件

| 组件 | 职责 | 文件位置 |
|------|------|----------|
| **KGExtractor** | 三元组提取器 | `knowledge_graph/kg_extractor.py` |
| **KGStorage** | 图谱存储管理 | `knowledge_graph/kg_storage.py` |
| **KGReasoning** | 图谱推理引擎 | `knowledge_graph/kg_reasoning.py` |
| **KGContext** | 上下文构建器 | `knowledge_graph/kg_context.py` |

#### 3.4.3 三元组提取模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **rule** | 纯规则/正则提取 | 零LLM开销，快速处理 |
| **llm** | LLM语义提取 | 高精度，复杂语义理解 |
| **hybrid** | 规则预筛 + LLM补充 | 推荐模式，平衡精度与开销 |

#### 3.4.4 支持的关系类型

| 类别 | 关系类型 | 示例 |
|------|----------|------|
| 人际关系 | friend_of, colleague_of, family_of, boss_of, knows | "小王是我的朋友" |
| 属性关系 | lives_in, works_at, studies_at, belongs_to, owns | "我住在北京" |
| 行为关系 | likes, dislikes, does, is, has, wants | "我喜欢编程" |
| 事件关系 | participated_in, happened_at, caused_by | "参加了年会" |
| 通用关系 | related_to | 其他关联 |

#### 3.4.5 图谱推理配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| max_depth | 3 | BFS最大跳数 |
| max_nodes_per_hop | 10 | 每跳最大节点数 |
| max_facts | 8 | 注入LLM的最大事实数 |
| min_confidence | 0.2 | 最低置信度阈值 |

---

### 3.5 主动回复模块 (Proactive Module)

#### 3.5.1 功能概述

主动回复模块负责在适当时机主动向用户发起对话，增强陪伴感。

#### 3.5.2 核心组件

| 组件 | 职责 | 文件位置 |
|------|------|----------|
| **ProactiveManager** | 主动回复管理器 | `proactive/proactive_manager.py` |
| **ProactiveReplyDetector** | 主动回复检测器 | `proactive/proactive_reply_detector.py` |
| **ProactiveEvent** | 合成事件构造器 | `proactive/proactive_event.py` |

#### 3.5.3 触发条件

| 触发类型 | 说明 | 紧急度 |
|----------|------|--------|
| **高情感信号** | 用户情绪强烈（强度>0.7） | critical |
| **问题信号** | 用户提出问题但无人回答 | high |
| **提及信号** | 用户提及Bot或相关话题 | medium |
| **话题信号** | 用户讨论Bot擅长的话题 | low |

#### 3.5.4 冷却机制

| 紧急度 | 冷却时间乘数 | 说明 |
|--------|--------------|------|
| critical | ×0.25 | 紧急事件几乎不受冷却限制 |
| high | ×0.5 | 较短冷却 |
| medium | ×1.0 | 默认冷却 |
| low | ×1.5 | 延长冷却 |

#### 3.5.5 群聊白名单管理

| 配置项 | 说明 |
|--------|------|
| group_whitelist | 静态白名单列表（配置文件） |
| group_whitelist_mode | 是否启用白名单模式 |
| dynamic_whitelist | 动态白名单（通过指令管理） |

#### 3.5.6 边界条件处理

| 场景 | 处理方式 |
|------|----------|
| 每日回复次数达到上限 | 跳过，不触发主动回复 |
| 群聊不在白名单中 | 跳过 |
| 冷却时间内 | 跳过 |
| 事件队列已满 | 丢弃任务，记录警告 |

---

## 4. 辅助模块功能说明

### 4.1 分析模块 (Analysis Module)

#### 4.1.1 RIF评分器

**功能**：计算记忆的时近性(Recency)、相关性(Importance)、频率(Frequency)综合评分。

**评分公式**：
```
RIF Score = 0.4 × Recency + 0.3 × Importance + 0.3 × Frequency
```

| 维度 | 计算方式 |
|------|----------|
| Recency | 基于最后访问时间的指数衰减 |
| Importance | 基于触发器质量和情感强度 |
| Frequency | 基于访问次数和创建时间 |

#### 4.1.2 情感分析器

**功能**：分析文本情感状态，识别主要情绪和强度。

**支持的情绪类型**：
- JOY（喜悦）、SADNESS（悲伤）、ANGER（愤怒）
- FEAR（恐惧）、DISGUST（厌恶）、SURPRISE（惊讶）
- ANXIETY（焦虑）、EXCITEMENT（兴奋）、CALM（平静）
- NEUTRAL（中性）

**分析模式**：
| 模式 | 说明 |
|------|------|
| rule | 基于关键词和规则 |
| llm | 使用LLM进行语义分析 |
| hybrid | 规则预筛 + LLM确认 |

#### 4.1.3 用户画像提取器

**功能**：从对话中提取用户特征，构建多维度用户画像。

**画像维度**：
| 维度 | 包含字段 |
|------|----------|
| 工作 | work_style, work_goals, work_challenges |
| 生活 | lifestyle, interests, habits |
| 情感 | emotional_baseline, emotional_volatility, emotional_triggers |
| 关系 | social_style, trust_level, intimacy_level |
| 人格 | Big Five人格特质（开放性、尽责性、外向性、宜人性、神经质） |
| 沟通 | communication_formality, communication_directness, communication_humor |
| 交互 | proactive_reply_preference, preferred_reply_style, topic_blacklist |

### 4.2 向量嵌入模块 (Embedding Module)

#### 4.2.1 功能概述

负责文本向量化，支持多种嵌入策略。

#### 4.2.2 嵌入策略

| 策略 | 说明 |
|------|------|
| auto | 自动选择（优先AstrBot API，回退本地模型） |
| astrbot | 使用AstrBot平台的嵌入API |
| local | 使用本地模型（sentence-transformers） |

#### 4.2.3 支持的模型

| 模型 | 维度 | 说明 |
|------|------|------|
| BAAI/bge-small-zh-v1.5 | 512 | 中文小模型，默认推荐 |
| BAAI/bge-base-zh-v1.5 | 768 | 中文基础模型 |
| BAAI/bge-large-zh-v1.5 | 1024 | 中文大模型 |

### 4.3 多模态模块 (Multimodal Module)

#### 4.3.1 图片分析器

**功能**：分析消息中的图片，提取视觉信息。

**分析模式**：
| 模式 | 说明 |
|------|------|
| auto | 自动判断是否需要分析 |
| brief | 简要描述 |
| detailed | 详细分析 |
| skip | 跳过分析 |

**预算控制**：
| 参数 | 默认值 | 说明 |
|------|--------|------|
| daily_analysis_budget | 100 | 每日最大分析次数 |
| session_analysis_budget | 20 | 每会话最大分析次数 |

**优化措施**：
- 跳过表情包图片
- 相似图片去重
- 上下文相关性过滤

### 4.4 LLM增强模块 (LLM Enhanced Module)

#### 4.4.1 功能概述

提供LLM增强的智能检测能力，提升各模块的准确性。

#### 4.4.2 增强组件

| 组件 | 功能 | 默认模式 |
|------|------|----------|
| LLMSensitivityDetector | 语义级敏感度检测 | rule |
| LLMTriggerDetector | 意图理解触发器检测 | rule |
| LLMEmotionAnalyzer | 语义级情感分析 | rule |
| LLMProactiveReplyDetector | 智能主动回复决策 | rule |
| LLMConflictResolver | 语义级冲突解决 | rule |
| LLMRetrievalRouter | 智能检索策略选择 | rule |

#### 4.4.3 模式说明

| 模式 | 说明 |
|------|------|
| rule | 仅使用规则（快速，零成本） |
| llm | 仅使用LLM（准确，消耗token） |
| hybrid | 混合模式（规则预筛 + LLM确认） |

---

## 5. 模块间交互关系与数据流向

### 5.1 主数据流图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户消息                                    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         main.py (Handler层)                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ on_all_messages()                                                │   │
│  │   ├── 过滤指令消息                                               │   │
│  │   ├── 更新成员身份信息                                           │   │
│  │   ├── 记录到聊天缓冲区 ──────────────────────────────────────┐   │   │
│  │   └── 调用 process_message_batch()                           │   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      MemoryService (Service层)                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ process_message_batch()                                          │   │
│  │   ├── MessageClassifier.classify() ────────┐                    │   │
│  │   │                                        │                    │   │
│  │   │   ┌────────────────────────────────────┼───────────────┐   │   │
│  │   │   │ immediate: 立即处理                 │               │   │   │
│  │   │   │ batch:     加入批量队列             │               │   │   │
│  │   │   │ discard:   丢弃                     │               │   │   │
│  │   │   └────────────────────────────────────┼───────────────┘   │   │
│  │   │                                        │                    │   │
│  │   └── BatchProcessor.add_message() ◄───────┘                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
┌───────────────────────────────┐   ┌───────────────────────────────┐
│      立即处理路径              │   │      批量处理路径              │
│  capture_and_store_memory()   │   │  BatchProcessor._process_queue│
│           │                   │   │           │                   │
│           ▼                   │   │           ▼                   │
│  CaptureEngine.capture_memory │   │  MessageMerger.merge()        │
│           │                   │   │           │                   │
│           ▼                   │   │           ▼                   │
│  ChromaManager.add_memory()   │   │  LLMProcessor.generate_summary│
│           │                   │   │           │                   │
│           ▼                   │   │           ▼                   │
│  KGExtractor.extract()        │   │  CaptureEngine.capture_memory │
│           │                   │   │           │                   │
│           ▼                   │   │           ▼                   │
│  PersonaExtractor.extract()   │   │  ProactiveManager.handle_batch│
└───────────────────────────────┘   └───────────────────────────────┘
```

### 5.2 LLM上下文注入流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      LLM请求事件 (on_llm_request)                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    prepare_llm_context()                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 情感状态更新                                                   │   │
│  │    EmotionAnalyzer.analyze_emotion()                            │   │
│  │    EmotionAnalyzer.update_emotional_state()                     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 2. 记忆检索                                                       │   │
│  │    RetrievalEngine.retrieve()                                   │   │
│  │      ├── RetrievalRouter.route() ── 选择策略                     │   │
│  │      ├── ChromaManager.query_memories() ── 向量检索              │   │
│  │      ├── SessionManager.get_working_memory() ── 工作记忆         │   │
│  │      └── Reranker.rerank() ── 重排序                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 3. 上下文构建                                                     │   │
│  │    ├── ChatHistoryBuffer.get_recent_messages() ── 聊天记录       │   │
│  │    ├── RetrievalEngine.format_memories_for_llm() ── 记忆格式化   │   │
│  │    ├── MemberIdentityService.resolve_tag() ── 成员识别           │   │
│  │    ├── KGModule.format_graph_context() ── 知识图谱               │   │
│  │    ├── ImageAnalyzer.format_for_llm_context() ── 图片分析        │   │
│  │    └── _build_behavior_directives() ── 行为指导                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 4. 注入系统提示                                                   │   │
│  │    req.system_prompt += context                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         LLM生成响应                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      LLM响应事件 (on_llm_response)                       │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. 记录Bot回复到聊天缓冲区                                        │   │
│  │ 2. 更新会话活动                                                   │   │
│  │ 3. 捕获用户消息记忆                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.3 模块依赖关系

```
MemoryService
    │
    ├── StorageModule
    │       ├── ChromaManager ────── EmbeddingManager
    │       ├── SessionManager
    │       ├── LifecycleManager
    │       └── ChatHistoryBuffer
    │
    ├── CaptureModule
    │       ├── CaptureEngine
    │       │       ├── TriggerDetector
    │       │       ├── SensitivityDetector
    │       │       ├── EmotionAnalyzer
    │       │       ├── EntityExtractor
    │       │       ├── RIFScorer
    │       │       └── ConflictResolver
    │       ├── BatchProcessor
    │       │       ├── MessageMerger
    │       │       └── LLMMessageProcessor
    │       └── MessageClassifier
    │
    ├── RetrievalModule
    │       ├── RetrievalEngine
    │       │       ├── Reranker
    │       │       ├── TokenManager
    │       │       └── PersonaCoordinator
    │       └── RetrievalRouter
    │
    ├── AnalysisModule
    │       ├── EmotionAnalyzer
    │       ├── PersonaExtractor
    │       └── RIFScorer
    │
    ├── ProactiveModule
    │       ├── ProactiveManager
    │       └── ProactiveReplyDetector
    │
    ├── KnowledgeGraphModule
    │       ├── KGExtractor
    │       ├── KGStorage
    │       ├── KGReasoning
    │       └── KGContext
    │
    └── LLMEnhancedModule
            ├── LLMSensitivityDetector
            ├── LLMTriggerDetector
            ├── LLMEmotionAnalyzer
            ├── LLMProactiveReplyDetector
            ├── LLMConflictResolver
            └── LLMRetrievalRouter
```

---

## 6. 业务处理流程

### 6.1 消息处理主流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            用户发送消息                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │        是否为指令消息？         │
                    └───────────────────────────────┘
                           │              │
                          是              否
                           │              │
                           ▼              ▼
                    ┌────────────┐  ┌───────────────────────────────────┐
                    │ 指令处理器  │  │ on_all_messages()                  │
                    │ 执行指令    │  │   ├── 更新成员身份                 │
                    └────────────┘  │   ├── 记录到聊天缓冲区             │
                                    │   └── 图片分析（如有）             │
                                    └───────────────────────────────────┘
                                                    │
                                                    ▼
                                    ┌───────────────────────────────┐
                                    │       消息分类                  │
                                    │ MessageClassifier.classify()  │
                                    └───────────────────────────────┘
                                           │        │        │
                                    immediate   batch    discard
                                           │        │        │
                                           ▼        ▼        ▼
                                    ┌──────────┐ ┌──────────┐ ┌──────┐
                                    │立即捕获  │ │批量队列  │ │跳过  │
                                    └──────────┘ └──────────┘ └──────┘
                                           │        │
                                           │        ▼
                                           │  ┌───────────────────────┐
                                           │  │   批量处理触发条件     │
                                           │  │ 数量阈值 OR 时间阈值   │
                                           │  └───────────────────────┘
                                           │        │
                                           ▼        ▼
                                    ┌───────────────────────────────────┐
                                    │         记忆捕获流程               │
                                    │   CaptureEngine.capture_memory()  │
                                    └───────────────────────────────────┘
                                                    │
                                    ┌───────────────┴───────────────┐
                                    ▼                               ▼
                            ┌──────────────┐               ┌──────────────┐
                            │  存储记忆     │               │  后台任务     │
                            │ ChromaDB     │               │  ├── 画像更新 │
                            │ SessionMgr   │               │  └── KG提取  │
                            └──────────────┘               └──────────────┘
                                                    │
                                                    ▼
                                    ┌───────────────────────────────┐
                                    │      主动回复检测              │
                                    │ ProactiveManager.handle_batch │
                                    └───────────────────────────────┘
                                           │            │
                                      需要回复        不需要
                                           │            │
                                           ▼            ▼
                                    ┌──────────────┐ ┌──────┐
                                    │ 注入事件队列  │ │结束  │
                                    └──────────────┘ └──────┘
```

### 6.2 记忆生命周期流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           新记忆创建                                     │
│                    CaptureEngine.capture_memory()                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │       初始存储层判定           │
                    │   _determine_storage_layer()  │
                    └───────────────────────────────┘
                           │              │              │
                      WORKING        EPISODIC        SEMANTIC
                           │              │              │
                           ▼              ▼              ▼
                    ┌────────────┐  ┌────────────┐  ┌────────────┐
                    │ 会话内存   │  │ ChromaDB   │  │ ChromaDB   │
                    │ 24小时TTL  │  │ 动态管理   │  │ 永久存储   │
                    └────────────┘  └────────────┘  └────────────┘
                           │              │
                           │              │
                    ┌──────┴──────────────┴──────┐
                    │      生命周期管理循环        │
                    │   LifecycleManager          │
                    └─────────────────────────────┘
                                    │
            ┌───────────────────────┼───────────────────────┐
            ▼                       ▼                       ▼
    ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
    │   升级检查     │       │   降级检查     │       │   归档检查     │
    │ WORKING→EPISODIC│     │ EPISODIC→WORKING│     │ RIF<阈值      │
    │ EPISODIC→SEMANTIC│    │                │       │ 30天未访问    │
    └───────────────┘       └───────────────┘       └───────────────┘
            │                       │                       │
            ▼                       ▼                       ▼
    ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
    │ 满足条件则升级 │       │ 满足条件则降级 │       │ 满足条件则归档 │
    └───────────────┘       └───────────────┘       └───────────────┘
```

### 6.3 主动回复流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        批量消息处理完成                                   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │    ProactiveManager.handle_batch    │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │        前置检查                │
                    │  ├── 功能是否启用              │
                    │  ├── 每日限制是否达到          │
                    │  └── 群聊是否在白名单          │
                    └───────────────────────────────┘
                           │              │
                         通过            不通过
                           │              │
                           ▼              ▼
                    ┌───────────────┐  ┌──────┐
                    │ 检测器分析     │  │跳过  │
                    │ analyze()     │  └──────┘
                    └───────────────┘
                           │
                           ▼
                    ┌───────────────────────────────┐
                    │      是否应该主动回复？        │
                    │   decision.should_reply       │
                    └───────────────────────────────┘
                           │              │
                          是              否
                           │              │
                           ▼              ▼
                    ┌───────────────┐  ┌──────┐
                    │ 冷却检查      │  │跳过  │
                    │ _is_in_cooldown│  └──────┘
                    └───────────────┘
                           │              │
                         通过            冷却中
                           │              │
                           ▼              ▼
                    ┌───────────────────────────────┐
                    │      创建主动回复任务          │
                    │   ProactiveReplyTask          │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      加入待处理队列            │
                    │   pending_tasks.put()         │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      处理循环                  │
                    │   _process_loop()             │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      延迟发送（按紧急度）       │
                    │   asyncio.sleep(delay)        │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      构造合成事件              │
                    │   ProactiveMessageEvent       │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      注入事件队列              │
                    │   event_queue.put()           │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │      完整Pipeline处理          │
                    │  人格注入 → 记忆注入 → LLM生成  │
                    │  → 结果装饰 → 发送             │
                    └───────────────────────────────┘
```

### 6.4 异常处理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           异常发生                                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │ 可恢复异常     │               │ 不可恢复异常   │
            │ ValueError    │               │ Exception     │
            │ TypeError     │               │               │
            └───────────────┘               └───────────────┘
                    │                               │
                    ▼                               ▼
            ┌───────────────┐               ┌───────────────┐
            │ 记录警告日志   │               │ 记录错误日志   │
            │ 返回默认值     │               │ 抛出/降级运行  │
            └───────────────┘               └───────────────┘
                                                    │
                                    ┌───────────────┴───────────────┐
                                    ▼                               ▼
                            ┌───────────────┐               ┌───────────────┐
                            │ 核心组件失败   │               │ 增强组件失败   │
                            │ 整体初始化失败 │               │ 降级运行       │
                            └───────────────┘               └───────────────┘
```

---

## 7. 关键功能点与技术实现要点

### 7.1 智能触发器检测

**技术要点**：
- 多模式匹配：支持显式关键词、偏好表达、情感词汇、关系描述等
- 置信度计算：基于匹配位置、关键词强度、上下文一致性
- LLM增强：可选的语义级意图理解

**实现策略**：
```
触发器置信度 = 基础置信度 + 位置加成 + 多触发器一致性加成
```

### 7.2 RIF评分算法

**技术要点**：
- 时近性(Recency)：指数衰减函数，新记忆权重更高
- 相关性(Importance)：基于触发器质量、情感强度、内容信息密度
- 频率(Frequency)：基于访问次数和创建时间间隔

**衰减半衰期配置**：
| 记忆类型 | 半衰期 | 衰减率λ |
|----------|--------|---------|
| 兴趣 | 30天 | 0.023 |
| 习惯 | 90天 | 0.008 |
| 人格 | 365天 | 0.002 |
| 价值观 | 730天 | 0.001 |

### 7.3 记忆去重与冲突检测

**技术要点**：
- 语义相似度计算：向量余弦相似度
- 冲突识别：语义相反的陈述
- 解决策略：保留最新、合并、LLM辅助决策

**阈值配置**：
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 重复判定阈值 | 0.95 | 相似度超过此值视为重复 |
| 冲突检测阈值 | 0.7 | 相似度在此范围检测冲突 |

### 7.4 批量处理优化

**技术要点**：
- 消息合并：短消息自动合并，减少处理次数
- 去重：相似消息去重
- LLM调用优化：批量只调用1次LLM
- 冷却控制：避免频繁LLM调用

**配置参数**：
| 参数 | 默认值 | 说明 |
|------|--------|------|
| batch_threshold_count | 20 | 触发批量处理的消息数 |
| batch_threshold_interval | 300s | 触发批量处理的时间间隔 |
| short_message_threshold | 15字符 | 短消息判定阈值 |
| merge_time_window | 60s | 消息合并时间窗口 |

### 7.5 场景自适应配置

**技术要点**：
- 活跃度检测：基于滑动窗口的消息频率统计
- 动态配置：根据活跃度等级调整各项参数
- 防抖机制：避免频繁升降级

**活跃度分级**：
| 等级 | 消息频率 | 冷却时间 | 每日回复上限 |
|------|----------|----------|--------------|
| quiet | <5条/时 | 120s | 8次 |
| moderate | 5-20条/时 | 60s | 15次 |
| active | 20-50条/时 | 45s | 22次 |
| intensive | >50条/时 | 30s | 25次 |

### 7.6 知识图谱推理

**技术要点**：
- 三元组提取：规则+LLM混合模式
- 图遍历：BFS多跳推理
- 置信度传播：沿推理路径递减

**推理配置**：
| 参数 | 默认值 | 说明 |
|------|--------|------|
| max_depth | 3 | 最大推理跳数 |
| max_nodes_per_hop | 10 | 每跳最大节点数 |
| confidence_decay | 0.8 | 每跳置信度衰减 |

### 7.7 隐私保护机制

**技术要点**：
- 敏感度自动检测：关键词+语义分析
- 可见性控制：私聊/群聊/群共享三级隔离
- 数据加密：敏感信息标记保护

**敏感信息类型**：
- 个人身份信息（姓名、电话、地址）
- 财务信息（银行卡、密码）
- 健康信息（病历、诊断）
- 亲密关系信息

---

## 8. 功能使用场景与限制条件

### 8.1 使用场景

#### 8.1.1 个人助手场景

| 场景 | 功能支持 |
|------|----------|
| 记住用户偏好 | 自动捕获"我喜欢..."、"我讨厌..."等表达 |
| 记住重要日期 | 捕获生日、纪念日等时间信息 |
| 记住人际关系 | 知识图谱记录朋友、家人关系 |
| 个性化回复 | 基于画像调整回复风格 |

#### 8.1.2 群聊场景

| 场景 | 功能支持 |
|------|----------|
| 群共识记忆 | 群活动、群规则等共享知识 |
| 成员识别 | 区分不同成员的个人信息 |
| 主动互动 | 适当时机主动发言 |
| 活跃度自适应 | 根据群活跃度调整行为 |

#### 8.1.3 长期陪伴场景

| 场景 | 功能支持 |
|------|----------|
| 情感追踪 | 记录用户情绪变化趋势 |
| 关系深化 | 信任度、亲密度渐进提升 |
| 话题延续 | 跨会话话题连贯性 |
| 成长记录 | 用户画像持续更新 |

### 8.2 限制条件

#### 8.2.1 技术限制

| 限制项 | 说明 |
|--------|------|
| 嵌入模型依赖 | 需要向量嵌入服务（本地或API） |
| ChromaDB依赖 | 需要安装chromadb库 |
| LLM依赖 | 部分增强功能需要LLM服务 |
| 内存占用 | 大量会话可能占用较多内存 |

#### 8.2.2 功能限制

| 限制项 | 说明 |
|--------|------|
| 记忆容量 | 工作记忆有上限，需定期升级/清理 |
| 检索精度 | 依赖嵌入模型质量 |
| 主动回复频率 | 受冷却时间和每日上限限制 |
| 图片分析预算 | 每日分析次数有限制 |

#### 8.2.3 隐私限制

| 限制项 | 说明 |
|--------|------|
| 敏感信息过滤 | 高敏感度内容可能被过滤 |
| 跨群隔离 | 群聊记忆不跨群共享 |
| 私聊隔离 | 私聊记忆仅创建者可见 |

### 8.3 配置建议

#### 8.3.1 小型部署（个人使用）

```
基础配置：
- enable_memory: true
- enable_inject: true
- max_context_memories: 3
- batch_threshold_count: 10

LLM增强：
- sensitivity_mode: rule
- trigger_mode: rule
- emotion_mode: rule
```

#### 8.3.2 中型部署（小规模群聊）

```
基础配置：
- enable_memory: true
- enable_inject: true
- max_context_memories: 5
- batch_threshold_count: 20
- proactive_reply.enable: true
- proactive_reply.group_whitelist_mode: true

LLM增强：
- sensitivity_mode: hybrid
- trigger_mode: rule
- emotion_mode: hybrid
```

#### 8.3.3 大型部署（大规模群聊）

```
基础配置：
- enable_memory: true
- enable_inject: true
- max_context_memories: 3
- batch_threshold_count: 50
- proactive_reply.enable: true
- proactive_reply.max_daily_replies: 50
- activity_adaptive.enable: true

LLM增强：
- sensitivity_mode: rule
- trigger_mode: rule
- emotion_mode: rule
- retrieval_mode: rule
```

### 8.4 常见问题与解决方案

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 记忆未被捕获 | 无触发器或被过滤 | 检查触发器配置，使用/memory_save手动保存 |
| 检索结果不准确 | 嵌入模型不匹配 | 检查embedding_model配置，考虑更换模型 |
| 主动回复不触发 | 白名单或冷却限制 | 检查群聊白名单配置，等待冷却时间 |
| 图片分析失败 | 预算耗尽或LLM不可用 | 检查daily_analysis_budget配置 |
| 初始化失败 | 依赖缺失或配置错误 | 检查chromadb安装，查看错误日志 |

---

## 附录

### A. 指令列表

| 指令 | 说明 | 权限 |
|------|------|------|
| `/memory_save <内容>` | 手动保存记忆 | 所有用户 |
| `/memory_search <查询>` | 搜索记忆 | 所有用户 |
| `/memory_clear` | 清除当前会话记忆 | 所有用户 |
| `/memory_delete [scope]` | 删除记忆（支持多范围） | 按范围 |
| `/memory_stats` | 查看记忆统计 | 所有用户 |
| `/proactive_reply <on\|off\|status\|list>` | 主动回复控制 | 管理员 |
| `/activity_status [all]` | 查看活跃度状态 | 管理员 |

### B. 配置项索引

详见 `_conf_schema.json` 配置文件。

### C. 版本历史

| 版本 | 主要更新 |
|------|----------|
| v1.6.0 | 知识图谱模块、场景自适应配置 |
| v1.5.0 | LLM增强模块、多模态支持 |
| v1.4.0 | 主动回复功能、用户画像v2 |
| v1.3.0 | 批量处理优化、消息合并 |
| v1.2.0 | 三层记忆架构、RIF评分 |
| v1.1.0 | 基础记忆捕获与检索 |
| v1.0.0 | 初始版本 |

---

*文档结束*

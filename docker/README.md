# Iris Memory Plugin - Docker æœ¬åœ°å¼€å‘ç¯å¢ƒ

> ç»Ÿä¸€çš„Dockeræœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œç”¨äºæµ‹è¯•Iris Memoryæ’ä»¶

## ğŸ“‹ ç›®å½•

- [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [æµ‹è¯•è¯´æ˜](#æµ‹è¯•è¯´æ˜)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### å¿…éœ€ç»„ä»¶

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ | æ£€æŸ¥å‘½ä»¤ |
|------|---------|---------|
| **Docker** | >= 20.10 | `docker --version` |
| **Docker Compose** | >= 2.0 | `docker-compose --version` æˆ– `docker compose version` |
| **ç£ç›˜ç©ºé—´** | è‡³å°‘10GB | `df -h` |
| **å†…å­˜** | è‡³å°‘4GB | `free -h` æˆ–ç³»ç»Ÿä¿¡æ¯ |

### å®‰è£…Docker

**macOS/Windows**:
1. ä¸‹è½½å¹¶å®‰è£… [Docker Desktop](https://www.docker.com/products/docker-desktop/)
2. å¯åŠ¨Docker Desktop
3. ç¡®ä¿DockeræœåŠ¡æ­£å¸¸è¿è¡Œ

**Linux (Ubuntu/Debian)**:
```bash
# å®‰è£…Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„
sudo usermod -aG docker $USER

# é‡æ–°ç™»å½•æˆ–è¿è¡Œ
newgrp docker
```

### éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥DockerçŠ¶æ€
docker info

# æµ‹è¯•Dockerè¿è¡Œ
docker run --rm hello-world
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®å¯åŠ¨

```bash
cd docker
./manager.sh start
```

**è®¿é—®åœ°å€**: http://localhost:6185

### é¢„æœŸæ•ˆæœ

1. **å®¹å™¨å¯åŠ¨æ—¶é—´**: 2-5åˆ†é’Ÿï¼ˆé¦–æ¬¡åŒ…å«é•œåƒä¸‹è½½ï¼‰
2. **WebUIå¯è®¿é—®**: http://localhost:6185
3. **æ’ä»¶å·²åŠ è½½**: åœ¨æ’ä»¶ç®¡ç†ä¸­æ˜¾ç¤º"Iris Memory"
4. **åŸºæœ¬åŠŸèƒ½æ­£å¸¸**: `/memory_save`, `/memory_search`, `/memory_stats`, `/memory_clear` æŒ‡ä»¤å¯ç”¨

---

## ğŸ“ æ–‡ä»¶è¯´æ˜

### é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| `Dockerfile` | 757B | AstrBot Dockeré•œåƒæ„å»ºæ–‡ä»¶ |
| `docker-compose.yml` | 1.1K | Docker Composeé…ç½®æ–‡ä»¶ |
| `.dockerignore` | 394B | Dockeræ„å»ºå¿½ç•¥è§„åˆ™ |

### ç®¡ç†è„šæœ¬

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `manager.sh` â­ | Dockerç¯å¢ƒç®¡ç†è„šæœ¬ï¼ˆå¯åŠ¨/åœæ­¢/é‡å¯/æ—¥å¿—/å¤‡ä»½ç­‰ï¼‰ |
| `test_docker.sh` â­ | Dockerç¯å¢ƒè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ |
| `docker-init.sh` | å®¹å™¨å¯åŠ¨åˆå§‹åŒ–è„šæœ¬ |

### æ–‡æ¡£æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `README.md` | æœ¬æ–‡æ¡£ï¼ˆDockerç¯å¢ƒå®Œæ•´æŒ‡å—ï¼‰ |

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. ç®¡ç†å‘½ä»¤

#### ä½¿ç”¨manager.shç®¡ç†

**å¯åŠ¨ç¯å¢ƒ**:
```bash
./manager.sh start
```

**åœæ­¢å®¹å™¨**:
```bash
./manager.sh stop
```

**é‡å¯å®¹å™¨**:
```bash
./manager.sh restart
```

**åœæ­¢å¹¶æ¸…ç†**:
```bash
./manager.sh down
```

**æŸ¥çœ‹æ—¥å¿—**:
```bash
./manager.sh logs
```

**æŸ¥çœ‹çŠ¶æ€**:
```bash
./manager.sh status
```

**è¿›å…¥å®¹å™¨shell**:
```bash
./manager.sh shell
```

**å¤‡ä»½æ•°æ®**:
```bash
./manager.sh backup
```

**æ¢å¤æ•°æ®**:
```bash
./manager.sh restore <backup_dir>
```

**é‡å»ºé•œåƒ**:
```bash
./manager.sh rebuild
```

#### äº¤äº’å¼èœå•

```bash
cd docker
./manager.sh
```

èœå•é€‰é¡¹ï¼š
```
è¯·é€‰æ‹©æ“ä½œ:
1) å¯åŠ¨ç¯å¢ƒ
2) åœæ­¢å®¹å™¨
3) é‡å¯å®¹å™¨
4) åœæ­¢å¹¶æ¸…ç†
5) æŸ¥çœ‹æ—¥å¿—
6) è¿›å…¥å®¹å™¨shell
7) æŸ¥çœ‹çŠ¶æ€
8) è¿è¡Œæµ‹è¯•
9) å¤‡ä»½æ•°æ®
10) æ¢å¤æ•°æ®
11) é‡å»ºé•œåƒ
0) é€€å‡º
```

### 2. å¯åŠ¨ç¯å¢ƒ

#### æ­¥éª¤1: å¯åŠ¨å®¹å™¨

```bash
cd docker
./manager.sh start
```

#### æ­¥éª¤2: ç­‰å¾…å¯åŠ¨

é¦–æ¬¡å¯åŠ¨éœ€è¦2-5åˆ†é’Ÿï¼š
- ä¸‹è½½åŸºç¡€é•œåƒï¼ˆ~500MBï¼‰
- å…‹éš†AstrBoté¡¹ç›®
- å®‰è£…ä¾èµ–
- å¯åŠ¨æœåŠ¡

æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨ï¼š

```bash
./manager.sh logs
```

çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—è¡¨ç¤ºå¯åŠ¨æˆåŠŸï¼š

```
AstrBot server started on http://0.0.0.0:7862
```

#### æ­¥éª¤3: è®¿é—®WebUI

æ‰“å¼€æµè§ˆå™¨è®¿é—®: **http://localhost:6185**

#### æ­¥éª¤4: å¯ç”¨æ’ä»¶

1. ç™»å½•AstrBot WebUI
2. è¿›å…¥"æ’ä»¶ç®¡ç†"é¡µé¢
3. æ‰¾åˆ° `Iris Memory` æ’ä»¶
4. ç‚¹å‡»å¯ç”¨

#### æ­¥éª¤5: æµ‹è¯•åŠŸèƒ½

åœ¨èŠå¤©æ¡†ä¸­è¾“å…¥æŒ‡ä»¤æµ‹è¯•ï¼š

```
# ä¿å­˜è®°å¿†
/memory_save æˆ‘æ˜¯æµ‹è¯•ç”¨æˆ·ï¼Œæˆ‘å–œæ¬¢ç¼–ç¨‹

# æœç´¢è®°å¿†
/memory_search æˆ‘å–œæ¬¢ä»€ä¹ˆ

# æŸ¥çœ‹ç»Ÿè®¡
/memory_stats

# æ¸…é™¤è®°å¿†
/memory_clear
```

#### æ­¥éª¤6: æµ‹è¯•è‡ªåŠ¨æ•è·

å‘é€æ™®é€šæ¶ˆæ¯æµ‹è¯•è‡ªåŠ¨æ•è·ï¼š

```
æˆ‘è§‰å¾—ä»Šå¤©å¿ƒæƒ…å¾ˆå¥½
Pythonæ˜¯æˆ‘çš„ç¼–ç¨‹è¯­è¨€
æˆ‘æ˜¯è½¯ä»¶å·¥ç¨‹å¸ˆ
```

### 3. å¼€å‘å·¥ä½œæµ

#### ä¿®æ”¹ä»£ç åçš„æµ‹è¯•æµç¨‹

**1. ä¿®æ”¹ä»£ç **

```bash
# åœ¨æœ¬åœ°ç¼–è¾‘æ’ä»¶ä»£ç 
vim ../iris_memory/capture/capture_engine.py
```

**2. çƒ­é‡è½½æ’ä»¶**ï¼ˆåœ¨WebUIä¸­ï¼‰

- è¿›å…¥"æ’ä»¶ç®¡ç†"é¡µé¢
- æ‰¾åˆ° `Iris Memory` æ’ä»¶
- ç‚¹å‡»å³ä¸Šè§’ `...` æŒ‰é’®
- é€‰æ‹© `é‡è½½æ’ä»¶`

**3. å¿«é€Ÿæµ‹è¯•**

```bash
# è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
./manager.sh test
```

**4. æ‰‹åŠ¨éªŒè¯**

åœ¨WebUIä¸­æµ‹è¯•åŠŸèƒ½

**5. å¦‚éœ€é‡å¯å®¹å™¨**

```bash
./manager.sh restart
```

#### å®Œæ•´é‡æ–°æ„å»º

å¦‚æœä¿®æ”¹äº†ä¾èµ–æˆ–é…ç½®ï¼š

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
./manager.sh down

# é‡å»ºé•œåƒ
./manager.sh rebuild

# å¯åŠ¨å®¹å™¨
./manager.sh start
```

---

## ğŸ§ª æµ‹è¯•è¯´æ˜

### è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•

```bash
cd docker
./manager.sh test
```

æˆ–ç›´æ¥è¿è¡Œï¼š

```bash
cd docker
./test_docker.sh
```

### æµ‹è¯•å†…å®¹

æµ‹è¯•è„šæœ¬ä¼šæ‰§è¡Œä»¥ä¸‹æ£€æŸ¥ï¼š

1. **å®¹å™¨å¥åº·çŠ¶æ€**: æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. **æ’ä»¶åŠ è½½**: æ£€æŸ¥æ’ä»¶æ˜¯å¦æˆåŠŸåŠ è½½
3. **æ’ä»¶ç›®å½•**: æ£€æŸ¥æ’ä»¶ç›®å½•ç»“æ„æ˜¯å¦æ­£ç¡®
4. **Pythonä¾èµ–**: æ£€æŸ¥å…³é”®Pythonä¾èµ–æ˜¯å¦å·²å®‰è£…
5. **æ’ä»¶å¯¼å…¥**: æ£€æŸ¥æ’ä»¶æ¨¡å—æ˜¯å¦å¯ä»¥æ­£ç¡®å¯¼å…¥
6. **æ•°æ®ç›®å½•**: æ£€æŸ¥æ•°æ®ç›®å½•æ˜¯å¦æ­£ç¡®åˆ›å»º
7. **æ—¥å¿—è¾“å‡º**: æ˜¾ç¤ºæœ€è¿‘çš„æ—¥å¿—è¾“å‡º
8. **å•å…ƒæµ‹è¯•**: è¿è¡Œpytestå•å…ƒæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

### é¢„æœŸè¾“å‡º

```
===================================
Dockerç¯å¢ƒæµ‹è¯•
===================================

[æµ‹è¯•1] æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
âœ“ å®¹å™¨çŠ¶æ€æ­£å¸¸

[æµ‹è¯•2] æ£€æŸ¥æ’ä»¶æ˜¯å¦åŠ è½½
âœ“ æ’ä»¶å·²åŠ è½½

[æµ‹è¯•3] æ£€æŸ¥æ’ä»¶ç›®å½•
âœ“ æ’ä»¶ç›®å½•å­˜åœ¨
âœ“ metadata.yaml å­˜åœ¨
âœ“ main.py å­˜åœ¨

...

===================================
æµ‹è¯•æ€»ç»“
===================================

æ‰€æœ‰åŸºç¡€æµ‹è¯•å·²å®Œæˆ

å¦‚éœ€æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ï¼Œè¯·è¿è¡Œ: manager.sh logs
å¦‚éœ€è¿›å…¥å®¹å™¨è°ƒè¯•ï¼Œè¯·è¿è¡Œ: manager.sh shell
```

---

## ğŸ—ï¸ æ¶æ„è¯´æ˜

### Dockerç¯å¢ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Docker Host (å®¿ä¸»æœº)             â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  AstrBot Container                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  AstrBot Core               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Star Plugin API          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - WebUI (port 7862)       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Message Processing       â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚              â†“                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Iris Memory Plugin         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Volume Mount: ../)        â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Capture Engine           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Retrieval Engine         â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - RIF Scorer               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Emotion Analyzer         â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚              â†“                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Chroma DB (Embedded)       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  (Volume: plugin-data)     â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Vector Storage           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - Semantic Search          â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†‘            â†‘              â”‚
â”‚            â”‚            â”‚              â”‚
â”‚      Volume Mount   Volume Mount       â”‚
â”‚       (Plugin)    (Local Data)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå‘

**1. è®°å¿†æ•è·æµç¨‹**
```
ç”¨æˆ·æ¶ˆæ¯ â†’ AstrBot Core â†’ Iris Memory Plugin
  â†“
Trigger Detection â†’ Emotion Analysis â†’ Quality Assessment
  â†“
RIF Scoring â†’ Chroma DB Storage (Local data directory)
```

**2. è®°å¿†æ£€ç´¢æµç¨‹**
```
ç”¨æˆ·æŸ¥è¯¢ â†’ AstrBot Core â†’ Iris Memory Plugin
  â†“
Hybrid Retrieval (Vector + RIF + Time + Emotion)
  â†“
Result Reranking â†’ Inject to LLM Context
```

**3. æ•°æ®æŒä¹…åŒ–**
```
å®¹å™¨å†…éƒ¨ â†’ æœ¬åœ°ç›®å½•
/app/astrbot/data â†’ ../data (é¡¹ç›®æ ¹ç›®å½•)
```

æ‰€æœ‰æ•°æ®ï¼ˆAstrBoté…ç½®ã€æ—¥å¿—ã€Chromaå‘é‡æ•°æ®åº“ï¼‰ç›´æ¥å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `data` æ–‡ä»¶å¤¹ä¸­ã€‚

### ç›®å½•æŒ‚è½½è¯´æ˜

| æŒ‚è½½ç±»å‹ | å®¿ä¸»æœºè·¯å¾„ | å®¹å™¨å†…è·¯å¾„ | ç”¨é€” |
|---------|-----------|-----------|------|
| **æ’ä»¶ç›®å½•** | `../` (é¡¹ç›®æ ¹ç›®å½•) | `/app/astrbot/data/plugins/astrbot_plugin_iris_memory` | å¼€å‘æ¨¡å¼çƒ­é‡è½½ |
| **æ•°æ®ç›®å½•** | `../data` (é¡¹ç›®æ ¹ç›®å½•) | `/app/astrbot/data` | æ‰€æœ‰æ•°æ®ï¼ˆAstrBoté…ç½®ã€æ—¥å¿—ã€Chromaå‘é‡æ•°æ®åº“ï¼‰ |

**å¼€å‘æ¨¡å¼ä¼˜åŠ¿**:
- æ’ä»¶ä»£ç æŒ‚è½½ä¸ºåªè¯»ï¼ˆ`:ro`ï¼‰
- ä¿®æ”¹ä»£ç åæ— éœ€é‡æ–°æ„å»ºå®¹å™¨
- é€šè¿‡WebUIé‡è½½æ’ä»¶å³å¯ç”Ÿæ•ˆ
- **æ•°æ®ç›´æ¥å­˜å‚¨åœ¨æœ¬åœ°ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œæ’æŸ¥é”™è¯¯**
- å¯ä»¥ç›´æ¥æŸ¥çœ‹å’Œä¿®æ”¹dataç›®å½•ä¸­çš„æ–‡ä»¶

---

## ğŸ”§ é…ç½®è¯´æ˜

### docker-compose.yml

```yaml
version: '3.8'

services:
  astrbot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: astrbot-iris-memory
    ports:
      - "6185:7862"
    volumes:
      # æ’ä»¶ç›®å½•ï¼ˆå¼€å‘æ¨¡å¼ï¼Œå®æ—¶æ›´æ–°ï¼‰
      - ../:/app/astrbot/data/plugins/astrbot_plugin_iris_memory:ro
      # æŒ‚è½½æ•°æ®ç›®å½•åˆ°æœ¬åœ°ï¼ˆæ–¹ä¾¿æ’æŸ¥é”™è¯¯ï¼‰
      - ../data:/app/astrbot/data
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    stdin_open: true
    tty: true
    networks:
      - astrbot-network
    # èµ„æºé™åˆ¶ï¼ˆå¯é€‰ï¼‰
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

networks:
  astrbot-network:
    driver: bridge
```

**å…³é”®é…ç½®**:
- æ’ä»¶ç›®å½•æŒ‚è½½ä¸ºåªè¯»ï¼ˆ`:ro`ï¼‰ï¼Œå¼€å‘æ¨¡å¼ä¸‹å®‰å…¨
- æ•°æ®ç›®å½•ç›´æ¥æŒ‚è½½åˆ°æœ¬åœ° `../data`ï¼Œæ–¹ä¾¿è°ƒè¯•
- èµ„æºé™åˆ¶ï¼š2 CPU, 2GBå†…å­˜
- ä½¿ç”¨å†…åµŒChromaDBï¼Œæ— éœ€ç‹¬ç«‹æœåŠ¡
- **ä¸å†ä½¿ç”¨Docker volumesï¼Œæ•°æ®ç›´æ¥å­˜å‚¨åœ¨é¡¹ç›®dataç›®å½•**

### Dockerfile

```dockerfile
FROM python:3.12-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…uv
RUN pip install uv

# å…‹éš†AstrBot
RUN git clone https://github.com/AstrBotDevs/AstrBot.git /app/astrbot

# è®¾ç½®å·¥ä½œç›®å½•åˆ°AstrBot
WORKDIR /app/astrbot

# åˆ›å»ºæ’ä»¶ç›®å½•
RUN mkdir -p /app/astrbot/data/plugins

# å®‰è£…AstrBotä¾èµ–
RUN uv sync

# æš´éœ²ç«¯å£
EXPOSE 7862

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV TZ=Asia/Shanghai

# å¯åŠ¨è„šæœ¬
COPY docker-init.sh /app/astrbot/docker-init.sh
RUN chmod +x /app/astrbot/docker-init.sh

# é»˜è®¤å¯åŠ¨å‘½ä»¤
CMD ["/bin/bash", "-c", "./docker-init.sh"]
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: ç«¯å£è¢«å ç”¨

**ç—‡çŠ¶**:
```
Error: bind: address already in use
```

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :6185

# æ–¹æ³•1: æ€æ‰å ç”¨è¿›ç¨‹
kill -9 <PID>

# æ–¹æ³•2: ä¿®æ”¹ç«¯å£ï¼ˆç¼–è¾‘docker-compose.ymlï¼‰
ports:
  - "6186:7862"  # æ”¹ç”¨6186ç«¯å£
```

---

### é—®é¢˜2: å®¹å™¨æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**:
```
Container exited with code 1
```

**æ’æŸ¥æ­¥éª¤**:

1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
./manager.sh logs
```

2. é‡æ–°æ„å»ºé•œåƒ
```bash
./manager.sh rebuild
```

3. æ£€æŸ¥ç£ç›˜ç©ºé—´
```bash
df -h
```

4. æ£€æŸ¥Dockerèµ„æº
```bash
docker system df
docker system prune -a  # æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
```

---

### é—®é¢˜3: æ’ä»¶æœªåŠ è½½

**ç—‡çŠ¶**:
- æ’ä»¶ç®¡ç†ä¸­çœ‹ä¸åˆ°"Iris Memory"
- æ’ä»¶åŠ è½½æ—¥å¿—ä¸­æ˜¾ç¤ºé”™è¯¯

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥æ’ä»¶ç›®å½•
```bash
./manager.sh shell
# åœ¨å®¹å™¨å†…æ‰§è¡Œ
ls -la /app/astrbot/data/plugins/astrbot_plugin_iris_memory/
```

2. æ£€æŸ¥metadata.yaml
```bash
./manager.sh shell
# åœ¨å®¹å™¨å†…æ‰§è¡Œ
cat /app/astrbot/data/plugins/astrbot_plugin_iris_memory/metadata.yaml
```

3. é‡å¯å®¹å™¨
```bash
./manager.sh restart
```

4. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
```bash
./manager.sh logs | grep -i "error\|iris"
```

---

### é—®é¢˜4: æ¨¡å—å¯¼å…¥é”™è¯¯

**ç—‡çŠ¶**:
```
ModuleNotFoundError: No module named 'iris_memory'
```

**è§£å†³æ–¹æ¡ˆ**:

å·²åœ¨ `main.py` ä¸­æ·»åŠ  `sys.path` ä¿®æ”¹ï¼Œç¡®ä¿æ’ä»¶æ ¹ç›®å½•åœ¨Pythonæœç´¢è·¯å¾„ä¸­ã€‚

å¦‚é—®é¢˜ä»ç„¶å­˜åœ¨ï¼š

1. æ£€æŸ¥æ’ä»¶ç›®å½•æ˜¯å¦æ­£ç¡®æŒ‚è½½
```bash
./manager.sh shell
# åœ¨å®¹å™¨å†…æ‰§è¡Œ
ls /app/astrbot/data/plugins/
```

2. æ£€æŸ¥main.pyä¸­çš„sys.pathè®¾ç½®
```bash
./manager.sh shell
# åœ¨å®¹å™¨å†…æ‰§è¡Œ
cat /app/astrbot/data/plugins/astrbot_plugin_iris_memory/main.py | head -20
```

3. é‡å¯å®¹å™¨
```bash
./manager.sh restart
```

---

### é—®é¢˜5: æ•°æ®ä¸¢å¤±

**ç—‡çŠ¶**:
å®¹å™¨é‡å¯åæ•°æ®ä¸è§äº†

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥æœ¬åœ°dataç›®å½•
```bash
ls -la ../data/
```

2. æ£€æŸ¥dataç›®å½•æŒ‚è½½
```bash
docker exec astrbot-iris-memory ls -la /app/astrbot/data
```

3. å¦‚æœdataç›®å½•ä¸ºç©ºï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å¤‡ä»½
```bash
ls -la ../backups/
```

4. å¤‡ä»½æ•°æ®ï¼ˆå®šæœŸï¼‰
```bash
cd docker
./manager.sh backup
```

5. æ¢å¤æ•°æ®
```bash
cd docker
./manager.sh restore backups/<timestamp>
```

---

### é—®é¢˜6: æ€§èƒ½é—®é¢˜

**ç—‡çŠ¶**:
- å“åº”å¾ˆæ…¢
- CPU/å†…å­˜å ç”¨è¿‡é«˜

**æ’æŸ¥æ­¥éª¤**:

1. æŸ¥çœ‹èµ„æºä½¿ç”¨
```bash
docker stats astrbot-iris-memory
```

2. æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯
```bash
docker inspect astrbot-iris-memory
```

3. æŸ¥çœ‹æ—¥å¿—é¢‘ç‡
```bash
docker logs astrbot-iris-memory --tail=100 | wc -l
```

4. ä¼˜åŒ–é…ç½®ï¼ˆç¼–è¾‘docker-compose.ymlï¼‰
```yaml
deploy:
  resources:
    limits:
      cpus: '1'        # é™ä½CPUé™åˆ¶
      memory: 1G       # é™ä½å†…å­˜é™åˆ¶
```

---

## âš™ï¸ é«˜çº§é…ç½®

### è‡ªå®šä¹‰ç«¯å£

å¦‚æœç«¯å£6185è¢«å ç”¨ï¼Œä¿®æ”¹ `docker-compose.yml`:

```yaml
ports:
  - "6186:7862"  # å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£
```

### èµ„æºé™åˆ¶è°ƒæ•´

æ ¹æ®æœºå™¨æ€§èƒ½è°ƒæ•´èµ„æºé™åˆ¶ï¼š

```yaml
deploy:
  resources:
    limits:
      cpus: '4'      # æé«˜åˆ°4æ ¸
      memory: 4G     # æé«˜åˆ°4GB
    reservations:
      cpus: '2'      # ä¿ç•™2æ ¸
      memory: 2G     # ä¿ç•™2GB
```

### ç¯å¢ƒå˜é‡é…ç½®

æ·»åŠ è‡ªå®šä¹‰ç¯å¢ƒå˜é‡ï¼š

```yaml
environment:
  - TZ=Asia/Shanghai
  - PYTHONUNBUFFERED=1
  - CHROMA_PERSIST_DIRECTORY=/app/astrbot/data/plugin_data/chroma
  - EMBEDDING_MODEL=BAAI/bge-m3
  - RIF_THRESHOLD=0.4
```

### æ—¥å¿—é…ç½®

é…ç½®æ—¥å¿—è½®è½¬ï¼Œé˜²æ­¢ç£ç›˜å æ»¡ï¼š

```yaml
logging:
  driver: "json-file"
  options:
    max-size: "10m"     # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§10MB
    max-file: "3"       # ä¿ç•™3ä¸ªæ—¥å¿—æ–‡ä»¶
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### å¼€å‘æµç¨‹

1. **å¿«é€ŸéªŒè¯**
   ```bash
   uv run pytest tests/ -v
   uv run python test_local.py
   ```

2. **Dockeré›†æˆæµ‹è¯•**
   ```bash
   cd docker
   ./manager.sh start
   ./manager.sh test
   ```

3. **WebUIæ‰‹åŠ¨æµ‹è¯•**
   - è®¿é—® http://localhost:6185
   - æµ‹è¯•æ‰€æœ‰åŠŸèƒ½

4. **çƒ­é‡è½½å¼€å‘**
   - ä¿®æ”¹ä»£ç 
   - WebUIé‡è½½æ’ä»¶
   - å¿«é€ŸéªŒè¯

5. **æ¸…ç†ç¯å¢ƒ**
   ```bash
   ./manager.sh down
   ```

### æ•°æ®ç®¡ç†

- **å®šæœŸå¤‡ä»½**:
  ```bash
  ./manager.sh backup
  ```

- **ç›‘æ§ç£ç›˜ç©ºé—´**:
  ```bash
  df -h
  docker system df
  ```

- **æ¸…ç†æœªä½¿ç”¨èµ„æº**:
  ```bash
  docker system prune -a
  ```

---

## ğŸ”— ç›¸å…³èµ„æº

### é¡¹ç›®æ–‡æ¡£

- **é¡¹ç›®README**: [`../README.md`](../README.md) - é¡¹ç›®ä¸»æ–‡æ¡£
- **æœ¬åœ°æµ‹è¯•**: [`../LOCAL_TEST_GUIDE.md`](../LOCAL_TEST_GUIDE.md) - æœ¬åœ°æµ‹è¯•æŒ‡å—

### åœ¨çº¿èµ„æº

- [AstrBotå®˜æ–¹æ–‡æ¡£](https://docs.astrbot.app/)
- [Dockerå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Docker Composeæ–‡æ¡£](https://docs.docker.com/compose/)

---

## â“ FAQ (å¸¸è§é—®é¢˜)

### Q1: ä¸ºä»€ä¹ˆéœ€è¦Dockerç¯å¢ƒï¼Ÿ

**A**: Dockerç¯å¢ƒæä¾›äº†ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ä¸€è‡´æ€§**: æ¶ˆé™¤ç¯å¢ƒå·®å¼‚ï¼Œç¡®ä¿æµ‹è¯•ç»“æœå¯é‡ç°
2. **éš”ç¦»æ€§**: ä¸æ±¡æŸ“æœ¬åœ°ç¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çª
3. **ä¾¿æºæ€§**: å¯ä»¥åœ¨ä»»ä½•æ”¯æŒDockerçš„æœºå™¨ä¸Šè¿è¡Œ
4. **å®Œæ•´æ€§**: åŒ…å«å®Œæ•´çš„AstrBotç¯å¢ƒå’Œæ‰€æœ‰ä¾èµ–

### Q2: å¦‚ä½•åœ¨Dockerä¸­è°ƒè¯•æ’ä»¶ï¼Ÿ

**A**:

1. **æŸ¥çœ‹å®æ—¶æ—¥å¿—**:
   ```bash
   ./manager.sh logs
   ```

2. **è¿›å…¥å®¹å™¨shell**:
   ```bash
   ./manager.sh shell
   ```

3. **åœ¨å®¹å™¨å†…è¿è¡Œæµ‹è¯•**:
   ```bash
   cd /app/astrbot/data/plugins/astrbot_plugin_iris_memory
   uv run pytest tests/ -v
   ```

4. **ä½¿ç”¨çƒ­é‡è½½**:
   - ä¿®æ”¹æœ¬åœ°ä»£ç ï¼ˆä¼šè‡ªåŠ¨æŒ‚è½½åˆ°å®¹å™¨ï¼‰
   - åœ¨WebUIä¸­é‡è½½æ’ä»¶
   - ç«‹å³æµ‹è¯•ä¿®æ”¹æ•ˆæœ

### Q3: æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿå¦‚ä½•æŸ¥çœ‹ï¼Ÿ

**A**:

æ•°æ®ç›´æ¥å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `data` æ–‡ä»¶å¤¹ä¸­ï¼š

```bash
# æŸ¥çœ‹æœ¬åœ°dataç›®å½•
ls -la ../data/

# æŸ¥çœ‹AstrBoté…ç½®
ls -la ../data/config/

# æŸ¥çœ‹Chromaå‘é‡æ•°æ®åº“
ls -la ../data/plugin_data/chroma/

# æŸ¥çœ‹æ—¥å¿—
tail -f ../data/logs/astrbot.log
```

**ä¼˜åŠ¿**: æ•°æ®ç›´æ¥åœ¨æœ¬åœ°ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œæ’æŸ¥é”™è¯¯ã€‚

**æ³¨æ„**: å¯ä»¥ç›´æ¥æŸ¥çœ‹å’Œä¿®æ”¹dataç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œä½†ä¿®æ”¹åå¯èƒ½éœ€è¦é‡å¯å®¹å™¨ã€‚

### Q4: å¦‚ä½•è¿ç§»æ•°æ®åˆ°æ–°ç¯å¢ƒï¼Ÿ

**A**:

```bash
# 1. å¤‡ä»½æ•°æ®
cd docker
./manager.sh backup

# 2. å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ°æ–°ç¯å¢ƒ
scp -r backups/* user@new-host:/path/to/astrbot_plugin_iris_memory/docker/backups/

# 3. åœ¨æ–°ç¯å¢ƒæ¢å¤
cd docker
./manager.sh restore backups/<timestamp>
```

---

## âœ… æ€»ç»“

Dockeræœ¬åœ°å¼€å‘ç¯å¢ƒæä¾›ï¼š

âœ… **å¿«é€Ÿå¯åŠ¨**: 2-5åˆ†é’Ÿå°±ç»ª
âœ… **å®Œæ•´æµ‹è¯•**: åŒ…å«æ‰€æœ‰ç»„ä»¶
âœ… **çƒ­é‡è½½**: ä¿®æ”¹ä»£ç åå¿«é€ŸéªŒè¯
âœ… **æ•°æ®æŒä¹…åŒ–**: é‡å¯ä¸ä¸¢å¤±æ•°æ®
âœ… **æœ¬åœ°å­˜å‚¨**: æ•°æ®ç›´æ¥å­˜å‚¨åœ¨é¡¹ç›®dataç›®å½•ï¼Œæ–¹ä¾¿è°ƒè¯•
âœ… **æ˜“äºç®¡ç†**: ç»Ÿä¸€çš„manager.shç®¡ç†è„šæœ¬
âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•**: ç‹¬ç«‹çš„test_docker.shæµ‹è¯•è„šæœ¬

**ç«‹å³å¼€å§‹**:
```bash
cd docker
./manager.sh start
```

**å¿«é€Ÿç´¢å¼•**:
- ç¯å¢ƒå‡†å¤‡: è§æœ¬æ–‡æ¡£[ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)ç« èŠ‚
- å¿«é€Ÿä¸Šæ‰‹: è§æœ¬æ–‡æ¡£[å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)ç« èŠ‚
- ç®¡ç†å‘½ä»¤: ä½¿ç”¨ `./manager.sh help` æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
- å®Œæ•´é…ç½®: è§[é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)ç« èŠ‚
- é«˜çº§é…ç½®: è§[é«˜çº§é…ç½®](#é«˜çº§é…ç½®)ç« èŠ‚
- æµ‹è¯•è¯´æ˜: è§[æµ‹è¯•è¯´æ˜](#æµ‹è¯•è¯´æ˜)ç« èŠ‚
- æ•…éšœæ’æŸ¥: è§[æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)ç« èŠ‚
- å¸¸è§é—®é¢˜: è§[FAQ](#faq-å¸¸è§é—®é¢˜)ç« èŠ‚

---

**æ›´æ–°æ—¶é—´**: 2026-01-31
**ç‰ˆæœ¬**: v2.0.0
**ç»´æŠ¤è€…**: Cassia

### æ›´æ–°æ—¥å¿—

**v2.0.0** (2026-01-31)
- ğŸ‰ é‡æ„Dockerç®¡ç†ç»“æ„ï¼Œç»Ÿä¸€ä½¿ç”¨manager.sh
- âœ… åˆ é™¤å†—ä½™æ–‡ä»¶ï¼ˆdocker-compose.quick.yml, Dockerfile.test, docker-quick-start.shï¼‰
- âœ… åˆ›å»ºç‹¬ç«‹test_docker.shæµ‹è¯•è„šæœ¬
- âœ… ä¼˜åŒ–æ–‡æ¡£ç»“æ„ï¼Œç®€åŒ–ä½¿ç”¨è¯´æ˜
- âœ… ä¿®å¤æ¨¡å—å¯¼å…¥é—®é¢˜ï¼ˆmain.pyä¸­æ·»åŠ sys.pathï¼‰
- âœ… ç»Ÿä¸€ç®¡ç†æ¥å£ï¼Œæä¾›å®Œæ•´çš„ç®¡ç†å‘½ä»¤

**v1.0.0** (2025-12-15)
- ğŸ‰ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… æ”¯æŒå¿«é€ŸDockeræµ‹è¯•
- âœ… æä¾›å®Œæ•´çš„æµ‹è¯•ç¯å¢ƒ
- âœ… åŒ…å«è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
